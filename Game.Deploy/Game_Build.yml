trigger: none

pool: Default

variables:
- group: 'DEV - Environment Variables'
- name: repository
  value: 'game-server'
- name: 'unityPath'
  value: '/opt/unity/editors/2022.3.4f1/Editor/Unity'

jobs:
- job: Build_Server
  steps:
  - task: Docker@2
    displayName: Build Image
    inputs:
      command: build
      repository: '$(repository)'
      dockerfile: '$(Build.SourcesDirectory)/Game.Server/Dockerfile'
      buildContext: $(Build.SourcesDirectory)
      tags: |
        latest
        $(Build.BuildNumber)
  - task: CmdLine@2
    displayName: Prune Dangling Images
    inputs:
      script: |
        docker image prune -f
- job: Build_Client
  steps:
  - task: DotNetCoreCLI@2
    displayName: Build Game.Common
    inputs:
      command: 'build'
      projects: "**/Game.Common.csproj"
      arguments: '--configuration Release --output $(Build.SourcesDirectory)/Game.Client/Assets/Scripts/Assemblies/'
      displayName: 'dotnet build $(buildConfiguration)'
  - script: |
      tree 

  - task: DownloadSecureFile@1
    name: unityLicense
    displayName: "Download Unity License"
    inputs:
        secureFile: "Unity_v2022.x.ulf"
  - script: |
      cp "$(unityLicense.secureFilePath)" Unity_v2022.x.ulf
      tree 
    displayName: "Copy License File"
  - script: |
      $(unityPath) -quit -batchmode -nographics -accept-apiupdate -manualLicenseFile Unity_v2022.x.ulf  -username "$(unityUsername)" -password "$(unityPassword)"
    displayName: "Login Via License File"
  - script: |
      $(unityPath) -quit -batchmode -nographics -accept-apiupdate -buildTarget StandaloneWindows -executeMethod Builder.Build -projectPath $(Build.SourcesDirectory)/Game.Client/ -outputPath $(Build.ArtifactStagingDirectory)
    displayName: "Build Client"
  - task: PublishBuildArtifacts@1
    displayName: Publish Build Artifact
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: 'Game.Client-$(Build.BuildNumber)' 
      publishLocation: 'Container'
  - script: |
      tree $(Build.ArtifactStagingDirectory)